<%# app/views/games/_board.html.erb %>
<div class="battlefield">
  
  <div class="opponent-zone">
    <div class="avatar">ğŸ‘¹</div>
    <div class="stats">
      <h3>Boss (Resists: <%= state['boss_resists'] %>)</h3>
      <%= render "games/health_bar", 
            current: state['boss_hp'], 
            max: state['boss_max_hp'], 
            color: 'red' 
      %>
    </div>
  </div>

  <div class="arena-zone">
    <% state['log'].last(3).each do |entry| %>
      <div class="action-log"><%= entry %></div>
    <% end %>
  </div>

  <div class="player-zone">
    <div class="player-stats">
      <div class="stat-group">
        <span>â¤ï¸ HP</span>
        <%= render "games/health_bar", 
              current: state['player_hp'], 
              max: state['player_max_hp'], 
              color: 'green' 
        %>
      </div>

      <div class="stat-group">
        <span>ğŸ’ Mana (<%= state['player_mana'] %>)</span>
        <div class="mana-bar-container">
          <div class="mana-fill" style="width: <%= (state['player_mana'].to_f / 10.0 * 100).clamp(0,100) %>%"></div>
        </div>
      </div>
    </div>

    <div class="hand-container">
  <%# CHANGE: use .each_with_index to get the integer position %>
  <% state['hand'].each_with_index do |card_string, index| %>
    
    <% 
       # Parse the string for display (Name & Cost)
       cost_match = card_string.match(/\((\d+)\)/)
       cost = cost_match ? cost_match[1].to_i : 0
       name = card_string.gsub(/\(\d+\)/, '').strip
    %>
    
    <%= render "games/card", 
          # PASS THE INDEX AS THE ID
          card: { 'id' => index, 'name' => name, 'cost' => cost },
          current_mana: state['player_mana'], 
          game_id: state['game_id'] 
    %>
  <% end %>
</div>
  </div>

  <% if state['current_question'].present? && state['questions_left'].to_i > 0 %>
    <%= render "games/flashcard_modal", 
          question_text: state['current_question'], 
          game_id: state['game_id'] 
    %>
  <% end %>

</div>